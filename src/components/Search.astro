<button class="search-trigger" id="search-trigger" aria-label="Search">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"/>
    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
  </svg>
</button>

<div class="search-overlay" id="search-overlay">
  <div class="search-modal">
    <button class="search-close" id="search-close" aria-label="Close search">&times;</button>
    <div id="search-container"></div>
  </div>
</div>

<style>
  .search-trigger {
    background: none;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    transition: all var(--transition-fast);
  }

  .search-trigger:hover {
    color: var(--color-white);
    border-color: var(--color-border-hover);
    background: rgba(50, 69, 255, 0.08);
  }

  .search-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 2000;
    background: rgba(10, 11, 20, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    align-items: flex-start;
    justify-content: center;
    padding-top: 12vh;
  }

  .search-overlay.active {
    display: flex;
  }

  .search-modal {
    width: 100%;
    max-width: 600px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    margin-inline: var(--space-4);
  }

  .search-close {
    position: absolute;
    top: var(--space-3);
    right: var(--space-4);
    background: none;
    border: none;
    color: var(--color-text-muted);
    font-size: var(--font-size-2xl);
    cursor: pointer;
    line-height: 1;
    transition: color var(--transition-fast);
    z-index: 1;
  }

  .search-close:hover {
    color: var(--color-white);
  }
</style>

<style is:global>
  :root {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: #3245ff;
    --pagefind-ui-text: #f0f0f5;
    --pagefind-ui-background: #12131f;
    --pagefind-ui-border: rgba(255, 255, 255, 0.08);
    --pagefind-ui-tag: rgba(50, 69, 255, 0.1);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 10px;
    --pagefind-ui-font: 'Inter', system-ui, -apple-system, sans-serif;
  }

  /* Search input */
  .pagefind-ui__search-input {
    color: #f0f0f5 !important;
    background: #0a0b14 !important;
    border-color: rgba(255, 255, 255, 0.12) !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: rgba(240, 240, 245, 0.4) !important;
  }

  .pagefind-ui__search-clear {
    color: rgba(240, 240, 245, 0.5) !important;
    background: none !important;
  }

  .pagefind-ui__search-clear:hover {
    color: #f0f0f5 !important;
  }

  /* Results count */
  .pagefind-ui__message {
    color: rgba(240, 240, 245, 0.5) !important;
    font-size: 0.8rem !important;
    padding-block: 0.75rem !important;
  }

  /* Result items */
  .pagefind-ui__result {
    border-top: 1px solid rgba(255, 255, 255, 0.06) !important;
    padding: 1rem 0 !important;
  }

  .pagefind-ui__result-link,
  .pagefind-ui__result-title {
    color: #ffffff !important;
    font-weight: 600 !important;
  }

  .pagefind-ui__result-link:hover {
    color: #7b8aff !important;
  }

  .pagefind-ui__result-excerpt {
    color: rgba(240, 240, 245, 0.6) !important;
    line-height: 1.6 !important;
    font-size: 0.85rem !important;
  }

  .pagefind-ui__result-nested .pagefind-ui__result-link,
  .pagefind-ui__result-nested .pagefind-ui__result-title {
    color: rgba(240, 240, 245, 0.85) !important;
    font-weight: 500 !important;
    font-size: 0.85rem !important;
  }

  /* Search term highlights */
  .pagefind-ui__result mark {
    color: #ffffff !important;
    background: rgba(50, 69, 255, 0.35) !important;
    border-radius: 2px;
    padding: 0.05em 0.2em;
  }
</style>

<script>
  function initSearch() {
    const trigger = document.getElementById('search-trigger');
    const overlay = document.getElementById('search-overlay');
    const closeBtn = document.getElementById('search-close');
    let initialized = false;

    function openSearch() {
      if (!overlay) return;
      overlay.classList.add('active');

      if (!initialized) {
        // Dynamically load Pagefind UI
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/pagefind/pagefind-ui.css';
        document.head.appendChild(link);

        const script = document.createElement('script');
        script.src = '/pagefind/pagefind-ui.js';
        script.onload = () => {
          // @ts-ignore
          new PagefindUI({
            element: '#search-container',
            showSubResults: true,
            showImages: false,
          });
          // Focus the search input
          const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
          if (input) input.focus();
        };
        document.head.appendChild(script);
        initialized = true;
      } else {
        const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        if (input) input.focus();
      }
    }

    function closeSearch() {
      if (!overlay) return;
      overlay.classList.remove('active');
    }

    trigger?.addEventListener('click', openSearch);
    closeBtn?.addEventListener('click', closeSearch);
    overlay?.addEventListener('click', (e) => {
      if (e.target === overlay) closeSearch();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSearch();
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
    });
  }

  initSearch();
</script>
